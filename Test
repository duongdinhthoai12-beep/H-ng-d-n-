local ref = cloneref or function(x) return x end
local S = function(n) return ref(game:GetService(n)) end

local Plrs, Tw, UIS, RS, Wk, CG =
	S("Players"), S("TweenService"), S("UserInputService"), S("RunService"), S("Workspace"), S("CoreGui")

local plr = Plrs.LocalPlayer

local function NA(i)
	if not i then return end
	i.Name = "\0"
	i.Archivable = false
end

local function parentUI(g)
	if gethui then
		NA(g); g.Parent = gethui(); return g
	elseif CG and CG:FindFirstChild("RobloxGui") then
		NA(g); g.Parent = CG:FindFirstChild("RobloxGui"); return g
	elseif CG then
		NA(g); g.Parent = CG; return g
	elseif plr and plr:FindFirstChildWhichIsA("PlayerGui") then
		NA(g); g.Parent = plr:FindFirstChildWhichIsA("PlayerGui"); g.ResetOnSpawn = false; return g
	end
	return g
end

local function getParts()
	local c = plr.Character or plr.CharacterAdded:Wait()
	local hum, hrp
	for _,d in ipairs(c:GetDescendants()) do
		if not hum and d:IsA("Humanoid") then hum = d end
		if not hrp and d:IsA("BasePart") and d.Name == "HumanoidRootPart" then hrp = d end
		if hum and hrp then break end
	end
	hum = hum or c:WaitForChild("Humanoid")
	hrp = hrp or c:WaitForChild("HumanoidRootPart")
	return c, hum, hrp
end

local function lockMouse(v)
	if UIS.MouseEnabled then
		UIS.MouseBehavior = v and Enum.MouseBehavior.LockCenter or Enum.MouseBehavior.Default
	end
end

local rotCon, oldAR
local function faceCam(h, hrp, v)
	if rotCon then rotCon:Disconnect() rotCon = nil end
	if v then
		oldAR = h.AutoRotate
		h.AutoRotate = false
		rotCon = RS.RenderStepped:Connect(function()
			local cam = Wk.CurrentCamera
			if not (hrp and cam) then return end
			local lv = cam.CFrame.LookVector
			local flat = Vector3.new(lv.X, 0, lv.Z)
			if flat.Magnitude > 1e-4 then
				hrp.CFrame = CFrame.lookAt(hrp.Position, hrp.Position + flat.Unit, Vector3.yAxis)
			end
		end)
	else
		if oldAR ~= nil then h.AutoRotate = oldAR end
	end
end

local function reapply(v)
	task.defer(function()
		local _, h, r = getParts()
		lockMouse(v)
		faceCam(h, r, v)
	end)
end

-- ðŸŸ¦ Giao diá»‡n
local gui = Instance.new("ScreenGui")
gui.Name = "ShiftLockUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
gui.DisplayOrder = 10000
parentUI(gui)

-- ðŸ”˜ NÃºt báº­t/táº¯t Shift Lock
local btn = Instance.new("ImageButton")
btn.Name = "LockBtn"
btn.AnchorPoint = Vector2.new(0.5, 0.5)
btn.Size = UDim2.fromOffset(64, 64)
btn.Position = UDim2.new(1, -96, 1, -96)
btn.BackgroundColor3 = Color3.fromRGB(34, 34, 38)
btn.AutoButtonColor = false
btn.Image = ""
btn.Active = true
btn.Parent = gui

local cr = Instance.new("UICorner")
cr.CornerRadius = UDim.new(1, 0)
cr.Parent = btn

-- ðŸŽ¯ Táº¡o tÃ¢m ngáº¯m giá»¯a mÃ n hÃ¬nh
local crosshair = Instance.new("Frame")
crosshair.Name = "Crosshair"
crosshair.AnchorPoint = Vector2.new(0.5, 0.5)
crosshair.Size = UDim2.fromOffset(6, 6)
crosshair.Position = UDim2.new(0.5, 0, 0.5, 0)
crosshair.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
crosshair.BorderSizePixel = 0
crosshair.BackgroundTransparency = 0.2
crosshair.Visible = false -- áº©n khi chÆ°a báº­t
crosshair.Parent = gui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(1, 0)
corner.Parent = crosshair

-- ðŸ”„ Xá»­ lÃ½ báº­t/táº¯t Shift Lock
local enabled = false

local function toggleShiftLock()
	enabled = not enabled
	reapply(enabled)
	btn.BackgroundColor3 = enabled and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(34, 34, 38)
	crosshair.Visible = enabled -- Hiá»‡n hoáº·c áº©n tÃ¢m
end

btn.MouseButton1Click:Connect(toggleShiftLock)
